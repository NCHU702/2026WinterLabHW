import os
import pandas as pd
import numpy as np
import json
# 正規化前的預備工作
# 讀取 train_data 中的所有 max 檔案，並計算 flood 和 rain 的最大值，輸出至 dataset_stats.json
def process_file(file_path):
    """讀取單個 CSV 並回傳最大值"""
    try:
        df = pd.read_csv(file_path, header=None)
        return df.values.max()
    except Exception as e:
        print(f"Error reading {file_path}: {e}")
        return 0.0

def scan_dataset(root_dir):
    print(f"正在掃描資料夾 (尋找 max 檔案): {root_dir}")
    
    rain_max_files = []
    flood_max_files = []

    # 1. 收集所有含有 'max' 的檔案路徑
    if not os.path.exists(root_dir):
        print(f"Error: {root_dir} not found.")
        return 0.0, 0.0

    for event_id in os.listdir(root_dir):
        event_path = os.path.join(root_dir, event_id)
        if not os.path.isdir(event_path):
            continue
            
        # Check Rain folder
        rain_dir = os.path.join(event_path, 'rain')
        if os.path.exists(rain_dir):
            rain_max_files.extend([
                os.path.join(rain_dir, f) 
                for f in os.listdir(rain_dir) 
                if 'max' in f and f.endswith('.csv') and not f.startswith('.')
            ])
            
        # Check Flood folder
        flood_dir = os.path.join(event_path, 'flood')
        if os.path.exists(flood_dir):
            flood_max_files.extend([
                os.path.join(flood_dir, f) 
                for f in os.listdir(flood_dir) 
                if 'max' in f and f.endswith('.csv') and not f.startswith('.')
            ])

    print(f"找到 {len(rain_max_files)} 個 Rain Max 檔案")
    print(f"找到 {len(flood_max_files)} 個 Flood Max 檔案")
    print("開始計算全域最大值...")

    # Initialize max values
    global_max_rain = 0.0
    global_max_flood = 0.0

    # 2. Process Rain Files
    if rain_max_files:
        # 讀取每個檔案的最大值
        results = [process_file(f) for f in rain_max_files]
        if results:
            global_max_rain = max(results)

    # 3. Process Flood Files
    if flood_max_files:
        results = [process_file(f) for f in flood_max_files]
        if results:
            global_max_flood = max(results)

    return global_max_rain, global_max_flood

if __name__ == "__main__":
    train_dir = os.path.join(os.getcwd(), 'train_data')
    output_json = 'dataset_stats.json'
    
    if os.path.exists(train_dir):
        max_r, max_f = scan_dataset(train_dir)
        print("-" * 30)
        print(f"掃描完成！")
        print(f"Max Rain:  {max_r}")
        print(f"Max Flood: {max_f}")
        
        # 儲存到 JSON
        stats = {
            "_description": "Normalization scaling factors for training. Generated by scan_dataset.py.",
            "max_rain": float(max_r),
            "max_flood": float(max_f)
        }
        with open(output_json, 'w') as f:
            json.dump(stats, f, indent=4)
            
        print("-" * 30)
        print(f"統計數據已儲存至: {output_json}")
    else:
        print(f"錯誤: 找不到訓練資料夾 {train_dir}")
